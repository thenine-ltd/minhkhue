import{j as R,W as q,a0 as A,T as j,k as b,o as y,l as G,w as $,M as w,t as P,y as h,Y as _,m as f,g as C,a1 as ue,a2 as de,a3 as T,a4 as pe,a5 as me,X as g,x as U,P as Y,a6 as S,L as H,p as E,a7 as L,a8 as N,a9 as Q,aa as ye,ab as _e,ac as fe,e as ee,d as z,ad as D,ae as he,af as K,ag as ge,ah as we,q as V,ai as ve,aj as Z,Z as Pe,ak as ke,al as xe,_ as be,am as X,H as te,an as Se,ao as Ce,ap as qe,b as Ae}from"../index.js";const $e={class:"bg-grey-2 q-pa-lg"},Te={class:"q-ma-none text-overline text-uppercase q-mb-sm"},Re={class:"q-px-xs text-h3"},Fe={class:"q-py-md bg-grey-3"},Ee=R({name:"AppPaymentGatewayCashTender",__name:"tender",props:{modelValue:{type:Boolean}},emits:["update:model-value"],setup(s,{emit:e}){const a=q(),r=A(),n=j(0),l=()=>{r.setProp("tenderedAmount",n.value),e("update:model-value",!1)},i=b(()=>[{type:"button",label:_(107),position:"left",hideOnTouch:!0,closePopup:!0},{type:"button",label:_(135),position:"right",positionTouch:"top",onClick:l}]);return(c,t)=>(y(),G(me,{"model-value":c.modelValue,"max-width":"md",actions:i.value,"onUpdate:modelValue":t[2]||(t[2]=o=>e("update:model-value",o))},{default:$(()=>[w("div",$e,[w("h6",Te,P(h(_)(135)),1),f(de,{modelValue:n.value,"onUpdate:modelValue":t[0]||(t[0]=o=>n.value=o),rules:[o=>o===0||o>=h(a).amount||h(_)(296)],borderless:"",autofocus:"","input-class":"text-right text-h3 q-pa-xs",color:"white",onKeyup:ue(l,["enter"])},{prepend:$(()=>[w("div",Re,P(h(C)("wc","currency_format_symbol")),1)]),_:1},8,["modelValue","rules","onKeyup"])]),f(T),w("div",Fe,[f(pe,{modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=o=>n.value=o),submit:l},null,8,["modelValue"])])]),_:1},8,["model-value","actions"]))}}),Ge={class:"q-px-lg q-py-md"},Ie={class:"no-margin text-overline text-uppercase text-grey-7"},Ve={key:0,class:"q-pa-lg bg-grey-2"},Me={class:"row q-col-gutter-lg"},Ne=R({name:"AppPaymentGatewayCash",__name:"cash",setup(s){const e=q(),a=A(),r=j(!1),n=b({set(c){a.setProp("tenderedAmount",c)},get(){return a.getProp("tenderedAmount")||0}}),l=b(()=>L(n.value)),i=b(()=>{if(C("pos","hide_tender_suggestions"))return[];const c=e.amount;let t=Math.ceil(c/5)*5;t=t<=c?t+5:t;let o=Math.floor(c/5)*5;o=o<=c?o+10:o;const m=o+10;return[c,t,o,m]});return(c,t)=>(y(),g(S,null,[w("div",Ge,[w("h6",Ie,P(h(_)(134)),1),f(Y,{modelValue:l.value,"onUpdate:modelValue":t[1]||(t[1]=o=>l.value=o),borderless:"","stack-label":"",readonly:"","input-class":"q-pa-none text-right text-h4 text-grey-8",color:"red"},{prepend:$(()=>[f(U,{flat:"",round:"",ripple:!1,icon:"mdi-calculator",onClick:t[0]||(t[0]=o=>r.value=!0)})]),_:1},8,["modelValue"])]),f(T),i.value.length?(y(),g("div",Ve,[w("div",Me,[(y(!0),g(S,null,H(i.value,(o,m)=>(y(),g("div",{key:m,class:"col-6"},[f(U,{ripple:!1,unelevated:"","no-caps":"",size:"xl",class:"full-width text-body1 text-weight-medium",align:"center","text-color":n.value===o?"white":"grey-8",color:n.value===o?"primary":"grey-4",label:h(L)(o),onClick:k=>n.value=o},null,8,["text-color","color","label","onClick"])]))),128))])])):E("",!0),i.value.length?(y(),G(T,{key:1})):E("",!0),r.value?(y(),G(Ee,{key:2,modelValue:r.value,"onUpdate:modelValue":t[2]||(t[2]=o=>r.value=o)},null,8,["modelValue"])):E("",!0)],64))}});function De(){window.addEventListener("appready",s=>{const{app:e,store:a}=s.detail,r=N(),n=q(a),l=A(a);async function i(){const t=l.getProp("tenderedAmount")||0,o=n.amount,m=t-o;return t<o?{ok:!1,message:_(296)}:(l.setProp("changeAmount",m),m?{ok:!0,review:{title:_(138),subtitle:L(m),buttonLabel:_(145),topBackground:m>0?"primary":"grey-9"}}:{ok:!0})}async function c(){return{ok:!0,summary:{autoClose:!0,status:n.processPaymentStatus},metaData:[{key:"wc_pos_amount_pay",value:l.getProp("tenderedAmount")||""},{key:"wc_pos_amount_change",value:l.getProp("changeAmount")||""}]}}e.component("AppPaymentGatewayCash",Ne),r.addFilter("paymentGateways","pos",t=>{const o=t.findIndex(m=>m.id==="pos_cash");return o!==-1&&(t[o].component="AppPaymentGatewayCash",t[o].setupPayment=i,t[o].processPayment=c),t})})}const Be={class:"q-px-lg q-py-md"},Ue={class:"q-ma-none text-overline text-uppercase text-weight-medium text-grey-8"},Le=R({name:"AppPaymentGatewayBacs",__name:"bacs",setup(s){return(e,a)=>(y(),g(S,null,[w("div",Be,[w("h6",Ue,P(h(_)(380)),1)]),f(T)],64))}});function Oe(){window.addEventListener("appready",s=>{const{app:e,store:a}=s.detail,r=N(),n=q(a);async function l(){return{ok:!0,summary:{autoClose:!0,status:n.processPaymentStatus}}}e.component("AppPaymentGatewayBacs",Le),r.addFilter("paymentGateways","pos",i=>{const c=i.findIndex(t=>t.id==="pos_bacs");return c!==-1&&(i[c].component="AppPaymentGatewayBacs",i[c].processPayment=l),i})})}const je={class:"q-px-lg q-py-md"},Qe={class:"q-ma-none text-overline text-uppercase text-weight-medium text-grey-8"},ze=R({name:"AppPaymentGatewayCheque",__name:"cheque",setup(s){return(e,a)=>(y(),g(S,null,[w("div",je,[w("h6",Qe,P(h(_)(381)),1)]),f(T)],64))}});function Ke(){window.addEventListener("appready",s=>{const{app:e,store:a}=s.detail,r=N(),n=q(a);async function l(){return{ok:!0,summary:{autoClose:!0,status:n.processPaymentStatus}}}e.component("AppPaymentGatewayCheque",ze),r.addFilter("paymentGateways","pos",i=>{const c=i.findIndex(t=>t.id==="pos_cheque");return c!==-1&&(i[c].component="AppPaymentGatewayCheque",i[c].processPayment=l),i})})}const Xe={class:"q-px-lg q-py-md"},We={class:"q-ma-none text-overline text-uppercase text-weight-medium text-grey-8"},Ze={class:"text-right"},Je=R({name:"AppPaymentGatewayChipAndPin",__name:"chip-and-pin",setup(s){const e=Q();return(a,r)=>(y(),g(S,null,[w("div",Xe,[w("h6",We,P(h(_)(245)),1),w("div",Ze,[h(e).isLoaded?(y(),G(Y,{key:1,modelValue:h(e).order.id,"onUpdate:modelValue":r[0]||(r[0]=n=>h(e).order.id=n),borderless:"","stack-label":"",readonly:"","input-class":"bg-white text-right text-h4 text-grey-8","bg-color":"grey-1"},null,8,["modelValue"])):(y(),G(ye,{key:0,class:"text-right",size:"40px",thickness:2,color:"grey-8"}))])]),f(T)],64))}});function Ye(){window.addEventListener("appready",s=>{const{app:e,store:a}=s.detail,r=N(),n=q(a);async function l(){return{ok:!0,summary:{autoClose:!0,status:n.processPaymentStatus}}}e.component("AppPaymentGatewayChipAndPin",Je),r.addFilter("paymentGateways","pos",i=>i.map(c=>(c.id.startsWith("pos_chip_and_pin")&&(c.component="AppPaymentGatewayChipAndPin",c.processPayment=l),c)))})}var O="https://js.stripe.com/terminal/v1",He=function(){var e=document.createElement("script");e.src=O;var a=document.head||document.body;if(!a)throw new Error("Expected document.body not to be null. Terminal requires a <body> element.");return a.appendChild(e),e},B=null,et=function(){return B!==null||(B=new Promise(function(e,a){if(typeof window>"u"){e(null);return}if(window.StripeTerminal){e(window.StripeTerminal);return}var r=document.querySelector('script[src="'.concat(O,'"], script[src="').concat(O,'/"]'))||He();r.addEventListener("load",function(){window.StripeTerminal?e(window.StripeTerminal):a(new Error("StripeTerminal not available"))}),r.addEventListener("error",function(){a(new Error("Failed to load StripeTerminal"))})})),B},ne=Promise.resolve().then(et),ae=!1;ne.catch(function(s){ae||console.warn(s)});var tt=function(){return ae=!0,ne},oe={},re={};(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;function e(r){this.name="ZeroDecimalError",this.message=r||"An error ocurred, if cant solve, create and issue on https://github.com/KelvinCampelo/zero-decimal-currencies",this.stack=new Error().stack}e.prototype=Object.create(e.prototype),e.prototype.constructor=e;var a=e;s.default=a})(re);(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.default=c,s.display=void 0;var e=a(re);function a(t){return t&&t.__esModule?t:{default:t}}var r=["BIF","CLP","DJF","GNF","JPY","KMF","KRW","MGA","PYG","RWF","UGX","VND","VUV","XAF","XOF","XPF"];function n(t,o){var m=new RegExp("^-?\\d+(?:.\\d{0,"+(o||-1)+"})?");return t.toString().match(m)[0]}function l(t,o,m){var k=t*Math.pow(10,m),x=Number(n(k,o).toString()),u=Number(n(t,o).toString()),d=x.toString().length-u.toString().length;return(u+(x%u>=Math.pow(10,d)/2)).toString()}var i=function(o,m){try{if(!isNaN(o)&&o)o=parseFloat(o.toString());else throw new e.default("The amount cannot be parsed to Float");if(Number(o)!==o)throw new e.default("The amount cannot be parsed to Float");return r.includes(m.toString().toUpperCase())?o.toFixed(0):(o/100).toFixed(2)}catch(k){throw console.log(k),new e.default}};s.display=i;function c(t,o,m,k){try{if(!t)throw new e.default("The amount value is required");if(!o)throw new e.default("The currency value is required");if(!isNaN(t)&&t)t=parseFloat(t.toString());else throw new e.default("The amount cannot be parsed to Float");if(Number(t)!==t)throw new e.default("The amount cannot be parsed to Float");if(r.includes(o.toString().toUpperCase()))return k?n(t,0):l(t,0,2);if(k)return m?n(t,2).toString():n(t,2).toString().replace(".","");var x=t;return t<.01?m?"0.00":"0":(x=t.toFixed(2),m?x:x.toString().replace(".",""))}catch(u){throw console.log(u),new e.default}}})(oe);var nt=_e(oe);function I(s){return fe(nt(s,C("wc","currency"),!1,!1))}function se(){const s=ee("stripe_terminal");return!s||s==="none"?"":C("pos","stripe_terminal_debug_mode")?"SIMULATOR":s}let v=null;function at(){v&&v.setSimulatorConfiguration({testPaymentMethod:"visa"})}async function M(){const s=A(),e=D(),a=async()=>{var c;const i=await z("stripe_create_connection_token");return i.ok?(c=i.body)!=null&&c.token?i.body.token:(e("Stripe: failed to create connection token.","error"),""):(e(i.body.message||"Stripe: failed to create connection token.","error"),"")},r=i=>{const{error:c}=i;console.warn(c),e("Reader disconnected unexpectedly.","warning")},n=i=>{const{status:c}=i;s.setProp("connectionStatus",c),v&&(c==="connected"?s.setProp("connectedReader",v.getConnectedReader()):s.setProp("connectedReader",null))},l=i=>{const{status:c}=i;s.setProp("paymentStatus",c)};if(!v){const i=await tt();i&&(v=i.create({onFetchConnectionToken:a,onUnexpectedReaderDisconnect:r,onConnectionStatusChange:n,onPaymentStatusChange:l}),C("pos","stripe_terminal_debug_mode",!1)&&at())}return v}async function J(){const s=A(),e=D();if(v){const r=s.getProp("paymentIntent").client_secret||"";v.collectPaymentMethod(r).then(async n=>{if("error"in n)throw new Error(n.error.message);s.setProp("paymentIntent",n.paymentIntent)}).catch(n=>{e(n.message||"Failed to collect payment method.","error")})}}async function ce(){var l;const s=q(),e=A(),a=e.getProp("paymentIntent"),r=a.status;s.loading.add("stripe_terminal_poll_payment_intent_status");const n=await z("stripe_retrieve_payment_intent",{id:a.id});if(n.ok&&((l=n.body)==null?void 0:l.object)==="payment_intent"){const i=n.body,c=i.status;if(r!==c){e.setProp("paymentIntent",i),s.loading.delete("stripe_terminal_poll_payment_intent_status");return}}setTimeout(ce,1e3)}async function W(){if(!v)return[];const s={simulated:C("pos","stripe_terminal_debug_mode",!1)};return v.discoverReaders(s).then(e=>{if("error"in e)throw new Error(e.error.message);const a=e.discoveredReaders,r=se();return r?a.filter(n=>n.id===r):a}).catch(e=>{throw new Error(e.mesasge||"Failed to discover readers.")})}async function ie(s){if(!v||v.getConnectionStatus()==="connecting")return!1;v.getConnectionStatus()==="connected"&&await v.disconnectReader();const e={fail_if_in_use:!0};return v.connectReader(s,e).then(a=>{if("error"in a){let r=`Failed to connect to reader ${s.label}`;switch(a.error.code){case"code":r="Error";break}throw new Error(r)}return a.reader}).catch(a=>{throw new Error((a==null?void 0:a.message)||"Failed to connect to reader.")})}async function le(s=[]){const e=s.length?s:await W(),a=se();if(!a)return!1;const r=e.find(n=>n.id===a);if(!r)throw new Error(`Default reader ${a} not found.`);return ie(r)}const ot={class:"q-px-lg q-py-md row"},rt={class:"q-ma-none col text-overline text-uppercase text-weight-medium text-grey-8"},st={class:"q-ma-none col-auto float-right"},ct={key:0,class:"q-pa-md bg-grey-2"},it={key:0,class:"row q-gutter-md"},lt={key:1},ut=R({name:"AppPaymentGatewayStripeTerminal",__name:"stripe-terminal",async setup(s){let e,a;const r=D(),n=q(),l=A(),i=([e,a]=he(()=>M()),e=await e,a(),e),c=b(()=>l.getProp("connectedReader")||null),t=b(()=>l.getProp("connectionStatus")||"not_connected"),o=j([]);async function m(u,d=!0){n.loading.add("stripe_terminal_connecting_reader"),ie(u).then(p=>{if(!p)throw new Error("Failed to connect to reader.");d&&r(`Connected to reader: ${p.label}`)}).catch(p=>{d&&r((p==null?void 0:p.message)||"Failed to connect to reader.","error")}).finally(()=>{n.loading.delete("stripe_terminal_connecting_reader")})}K(t,u=>{n.gateway==="pos_stripe_terminal"&&(l.disableButton=u!=="connected",n.screen==="review"&&(n.screen="payment",r("Reader was disconnected.","warning")))}),ge(()=>{const u=i==null?void 0:i.getConnectedReader();if(u){o.value=[u],l.setProp("connectedReader",u);return}k()});async function k(){n.loading.add("stripe_terminal_loading_readers"),W().then(u=>(o.value=u,le(o.value))).catch(u=>{r(u.message||"Failed to load readers.","error")}).finally(()=>{n.loading.delete("stripe_terminal_loading_readers")})}const x=b(()=>n.loading.has("stripe_terminal_loading_readers"));return(u,d)=>(y(),g(S,null,[w("div",ot,[w("h6",rt,P(h(_)(382)),1),w("h6",st,[f(U,{size:"md",padding:"xs",round:"",flat:"",icon:"mdi-reload",color:"transparent","text-color":"grey-8",onClick:k},{default:$(()=>[f(we,null,{default:$(()=>[V(P(h(_)(501)),1)]),_:1})]),_:1})])]),f(T),o.value.length||!x.value?(y(),g("div",ct,[o.value.length?(y(),g("div",it,[(y(!0),g(S,null,H(o.value,p=>(y(),G(be,{key:p.id,class:"col-3 cursor-pointer bg-white text-grey-8",flat:"",bordered:"",onClick:F=>m(p)},{default:$(()=>{var F;return[f(Z,null,{default:$(()=>[f(Pe,{src:`${h(C)("pos","public_url")}checkout/gateways/stripe-terminal/${p.device_type}.jpg`,transition:"none",ratio:"1",fit:"contain",class:"q-pa-sm"},{loading:$(()=>[f(ke,{color:"primary",size:"sm"})]),_:2},1032,["src"])]),_:2},1024),f(T,{color:"grey-3"}),f(Z,{class:xe({"bg-light-green-1":((F=c.value)==null?void 0:F.id)===p.id})},{default:$(()=>[V(P(p.label),1)]),_:2},1032,["class"])]}),_:2},1032,["onClick"]))),128))])):x.value?E("",!0):(y(),g("div",lt,[f(ve,{message:{text:h(_)(340),type:"warning"}},null,8,["message"])]))])):E("",!0),f(T)],64))}}),dt={class:"q-pa-lg row fit"},pt={class:"col self-center text-center text-body1 text-grey-8 q-ma-none"},mt=R({name:"AppPaymentGatewayStripeTerminalReview",__name:"review",setup(s){const e=X(),a=A(),r=Q();let n=null;te(async()=>{if(n=await M(),n){const i={type:"cart",cart:{line_items:r.order.line_items.map(c=>({description:c.name,amount:I(c.total),quantity:c.quantity})),discounts:r.order.coupon_lines.map(c=>({description:c.code,amount:I(c.discount)})),total:I(r.order.total),tax:I(r.order.total_tax),currency:r.order.currency}};n.setReaderDisplay(i)}}),Se(()=>{n&&n.clearReaderDisplay()});const l=b(()=>a.getProp("paymentStatus")||"not_ready");return K(l,i=>{e.disableButton=i!=="ready"}),(i,c)=>(y(),g("div",dt,[w("p",pt,P("Review order details on the selected reader. Collect payment when the card is present."),1)]))}}),yt={class:"q-pa-lg row fit"},_t={key:0,class:"col self-center text-center text-body1 text-grey-8 q-ma-none"},ft=R({name:"AppPaymentGatewayStripeTerminalCollectPayment",__name:"collect-payment",setup(s){const e=A(),a=X(),r=q(),n=D(),{processPayment:l}=Ce(),i=b(()=>{const t=e.getProp("paymentIntent");return(t==null?void 0:t.status)||""}),c=b(()=>["requires_payment_method","requires_source"].includes(i.value));return te(()=>{J()}),qe(()=>{a.icon=c.value?"mdi-contactless-payment":"mdi-check-circle"}),K(i,t=>{if(t==="requires_confirmation"){l();return}if(["requires_payment_method","requires_source"].includes(t)){J();return}if(["requires_action","requires_source_action"].includes(t)){ce();return}t==="canceled"&&(n("Payment was canceled.","warning"),r.screen="payment")}),(t,o)=>(y(),g("div",yt,[h(r).loading.size===0?(y(),g("p",_t,[i.value==="requires_confirmation"?(y(),g(S,{key:0},[V(P(h(_)(420)),1)],64)):i.value==="requires_action"?(y(),g(S,{key:1},[V(P(h(_)(384)),1)],64)):(y(),g(S,{key:2},[V(P(h(_)(384)),1)],64))])):E("",!0)]))}});function ht(){window.addEventListener("appready",s=>{const{app:e,store:a}=s.detail,r=N(),n=q(a),l=A(a),i=X(a),c=Q(),t=D();async function o(){i.$state={component:"AppPaymentGatewayStripeTerminalCollectPayment",hideButton:!0,title:_(139),icon:"mdi-contactless-payment"}}async function m(){var F;const u=["card_present"];C("wc","base_country")==="CA"&&u.push("interac_present");const d=await z("stripe_create_payment_intent",{amount:String(I(c.order.total)),currency:C("wc","currency"),payment_method_types:JSON.stringify(u),capture_method:"automatic",order_number:c.order.number});if(!d.ok)return{ok:!1,message:d.body.message||"Failed to create payment intent."};if(!((F=d.body)!=null&&F.id))return{ok:!1,message:"Failed to create payment intent."};const p={...d.body,sdk_payment_details:{}};return l.setProp("paymentIntent",p),ee("stripe_terminal_skip_review")?{ok:!0,review:{component:"AppPaymentGatewayStripeTerminalCollectPayment",hideButton:!0,title:_(139),icon:"mdi-contactless-payment"}}:{ok:!0,review:{icon:"fact_check",title:_(422),buttonLabel:_(418),buttonOnClick:o,component:"AppPaymentGatewayStripeTerminalReview"}}}async function k(){const u=await M();if(u){const d=l.getProp("paymentIntent");if(!d||d.object!=="payment_intent")return{ok:!1,message:"Could not process payment: payment intent is invalid."};const p=await u.processPayment(d);if("error"in p)return p.error.payment_intent&&l.setProp("paymentIntent",p.error.payment_intent),{ok:!1,message:p.error.message||"Could not process payment."};if(p.paymentIntent.status==="succeeded")return{ok:!0,summary:{autoClose:!0,status:n.processPaymentStatus}}}return{ok:!1,message:"Could not connect to Stripe Terminal. Please try again."}}async function x(){const u=await M();return u&&["waiting_for_input","processing"].includes(u.getPaymentStatus())?u.cancelCollectPaymentMethod().then(d=>{if("error"in d)throw new Error(d.error.message);return{ok:!0,message:"Payment was canceled."}}).catch(d=>({ok:!1,message:(d==null?void 0:d.message)||"Could not cancel the active payment. Please try again."})):{ok:!0,message:"No payment to cancel."}}e.component("AppPaymentGatewayStripeTerminal",ut),e.component("AppPaymentGatewayStripeTerminalReview",mt),e.component("AppPaymentGatewayStripeTerminalCollectPayment",ft),r.addFilter("paymentGateways","pos",u=>{const d=u.findIndex(p=>p.id==="pos_stripe_terminal");return d!==-1&&(u[d].component="AppPaymentGatewayStripeTerminal",u[d].setupPayment=m,u[d].processPayment=k,u[d].cancelPayment=x),u}),M().then(u=>{!u||W().then(async d=>le(d).then(p=>{p&&console.info(`Connected to the default reader: ${p.label}`)}).catch(p=>{console.error(p.message),t("Failed to connect to the default reader.","error")}))})})}var wt=Ae(()=>{const s=C("pos","payment_gateways"),e={pos_cash:De,pos_bacs:Oe,pos_cheque:Ke,pos_chip_and_pin:Ye,pos_stripe_terminal:ht};s.forEach(a=>{var r;(r=e[a.id])==null||r.call(e)})});export{wt as default};
